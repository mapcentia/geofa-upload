<html>
<head>
    <script src="https://geofa.geodanmark.dk/js/jquery/1.10.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>
    <style>
        .star {
            font-size: 25px;
            color: gold;
        }
    </style>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const facilitetId = urlParams.get('objekt_id');
        const theme = urlParams.get('theme');
        const functions = {
            getDetached: () => {
                $.ajax({
                    url: '/extensions/fkgupload/api/process/7901/' + facilitetId,
                    dataType: 'json',
                    success: function (data) {
                        let detached = $("#detached-container");
                        detached.empty();
                        if (data?.data) {
                            data.data.forEach((e) => {
                                let id = `attach_${e}`
                                let img = `<div class="col gy-2"><div class="card" style="width: 100%;">
                                            <img style="width: 100%; height:170px; object-fit: cover" src="https://mapcentia-www.s3-eu-west-1.amazonaws.com/fkg/360/${e}.jpg" class="card-img-top" alt="...">
                                            <div class="card-body" style="align-self: center">
                                               <button id="${id}" class="btn btn-outline-success btn-sm">Tilknyt</button>
                                            </div>
                                           </div></div>`;
                                detached.append(img)
                                $(`#${id}`).on("click", () => {
                                    functions.attach(e)
                                })
                            })
                        }
                    }
                })
            },
            getAttached: () => {
                $.ajax({
                    url: '/extensions/fkgupload/api/process/7900/' + facilitetId,
                    dataType: 'json',
                    success: (data) => {
                        let attached = $("#attached-container");
                        attached.empty();
                        if (data?.data) {
                            data.data.forEach((o) => {
                                let e = o[0];
                                let isPri = o[1];
                                let forbindelsesId = o[2];
                                let id = `detach_${e}`
                                let idp = `primary_${e}`
                                let img = `<div class="col gy-2"><div class="card" style="width: 100%;">
                                            <img style="width: 100%; height:170px; object-fit: cover" src="https://mapcentia-www.s3-eu-west-1.amazonaws.com/fkg/360/${e}.jpg" class="card-img-top" alt="...">
                                            <div style="position: absolute; right: 1px; top: 1px; width: 23px; height: 23px; background-color: white">
                                            <i data-bs-toggle="tooltip" data-bs-placement="left" title="Sæt som primær foto" class="bi-star${(isPri === 1 ? "-fill" : "")}" style="color: gold; position: absolute; right: 3px; top: 3px" id="${idp}"></i>
                                            </div>
                                            <div class="card-body" style="align-self: center">
                                <button id="${id}" class="btn btn btn-outline-danger btn-sm">Slet tilknyt</button>


                                            </div>
                                           </div></div>`;
                                attached.append(img)
                                $(`#${id}`).on("click", () => {
                                    functions.detach(forbindelsesId)
                                })
                                $(`#${idp}`).on("click", () => {
                                    functions.setPrimary(forbindelsesId)
                                })
                            })
                        }
                    },
                    error: () => {
                        alert();
                    }
                })
            },
            attach: (photo) => {
                $.ajax({
                    url: '/extensions/fkgupload/api/process/7900',
                    dataType: 'json',
                    method: 'POST',
                    contentType: "application/json; charset=utf-8",
                    scriptCharset: "utf-8",
                    data: JSON.stringify({
                        "tema": theme,
                        "foto_objek": facilitetId,
                        "foto_lokat": photo
                    }),
                    success: function () {
                        functions.update();
                    },
                    error: () => {
                        alert();
                    }

                })

            },
            detach: (objekt_id) => {
                $.ajax({
                    url: '/extensions/fkgupload/api/process/7900/' + objekt_id,
                    dataType: 'json',
                    method: 'DELETE',
                    contentType: "application/json; charset=utf-8",
                    scriptCharset: "utf-8",
                    success: function () {
                        functions.update();
                    },
                    error: () => {
                        alert();
                    }
                })

            },
            setPrimary: (forbindelsesId) => {
                $.ajax({
                    url: '/extensions/fkgupload/api/process/7900/',
                    dataType: 'json',
                    method: 'PUT',
                    contentType: "application/json; charset=utf-8",
                    scriptCharset: "utf-8",
                    data: JSON.stringify({
                        "objekt_id": facilitetId,
                        "objekt_id_7900": forbindelsesId
                    }),
                    success: function () {
                        functions.update();
                    },
                    error: () => {
                        alert();
                    }
                })

            },
            update: () => {
                functions.getAttached();
                functions.getDetached();
                functions.enableToolTip();
            },
            enableToolTip: () => {
                let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                })
            }
        }
        functions.update();

    </script>
</head>
<body>
<div class="container-fluid">
    <ul class="nav nav-tabs nav-fill" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="attached-tab" data-bs-toggle="tab" data-bs-target="#attached"
                    type="button" role="tab" aria-controls="attached" aria-selected="true">Tilknyttede
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="detached-tab" data-bs-toggle="tab" data-bs-target="#detached" type="button"
                    role="tab" aria-controls="detached" aria-selected="false">Ikke tilknyttede
            </button>
        </li>
    </ul>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="attached" role="tabpanel" aria-labelledby="attached-tab">
            <div class="container-fluid">
                <div class="row row-cols-2" id="attached-container">
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="detached" role="tabpanel" aria-labelledby="detached-tab">
            <div class="container-fluid">
                <div class="row row-cols-2" id="detached-container">
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
